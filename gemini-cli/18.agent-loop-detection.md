# Gemini CLI 模块解析：循环检测与安全机制

本文档深入解析了 Gemini CLI 为保证 Agent 健壮性而设计的核心安全功能之一：`LoopDetectionService`（循环检测服务）。

## 1. 功能概述与价值

AI Agent 在执行复杂任务时，一个常见的失败模式是陷入“无效循环”。例如，Agent 可能会因为对环境理解有误或工具返回结果不符合预期，而反复地、连续地使用完全相同的参数调用同一个工具，这不仅无法完成任务，还会浪费大量的 API 调用和计算资源。

`LoopDetectionService` 的职责就是作为 Agent 的“熔断器”，监控其行为模式，在检测到这种无效循环时主动中断任务，并将控制权交还给用户。这是一个确保 Agent 可靠、不会“卡死”或失控的关键安全机制。

## 2. 核心组件与文件

- **`packages/core/src/services/loopDetectionService.ts`**: `LoopDetectionService` 类的完整实现，包含了所有检测算法的逻辑。
- **`packages/core/src/core/client.ts`**: `GeminiClient` 类，负责在主流程中集成和调用 `LoopDetectionService`。
- **`packages/cli/src/ui/hooks/useGeminiStream.ts`**: UI 层的 Hook，负责在检测到循环后，向用户弹出确认对话框。

## 3. 多层次的“纵深防御”检测策略

`LoopDetectionService` 并未依赖单一的检测算法，而是采用了一套包含三种不同机制的“纵深防御”策略，以应对不同类型的循环模式。

### 3.1. 机制一：连续相同工具调用检测 (`checkToolCallLoop`)

这是最基础、最高效的检测层，用于捕捉最明显的重复行为。

- **原理**: 服务会计算每一次工具调用（包含工具名和所有参数）的哈希值，并与上一次的哈希值进行比较。
- **触发条件**: 当**连续 5 次**工具调用的哈希值完全相同时，即判定为循环。
- **适用场景**: 能有效防止因工具执行失败或返回空结果，导致模型固执地重试完全相同的操作。

### 3.2. 机制二：内容“吟唱”检测 (`checkContentLoop`)

此机制用于检测模型是否在反复输出无意义的、高度重复的文本，即“吟唱”（Chanting）。

- **原理**: 这是一个巧妙的滑动窗口算法。它持续分析模型流式输出的文本，将其分割成小的、重叠的内容块（chunk），并计算每个块的哈希值。
- **触发条件**: 如果在很短的文本距离内，同一个内容块（即相同的哈希值）**重复出现了 10 次**，则判定为内容吟唱循环。
- **智能豁免**: 该算法足够智能，它会自动在 Markdown 的代码块（` ``` `）内部**禁用检测**，因为在代码中，重复的缩进和语法结构是正常的，不应被误判为循环。

### 3.3. 机制三：基于 LLM 的“认知循环”检测 (`checkForLoopWithLLM`)

这是最高级、最智能的检测层，它利用 LLM 来判断 LLM 是否“思维卡壳”。

- **原理**: 当一个任务过于复杂，模型可能会陷入一种“认知循环”——它没有重复完全相同的操作，但其行为序列失去了逻辑上的推进，在几个相似的状态之间来回摆动。
- **触发时机**: 此检测成本较高，因此只在单个提示已经过多轮交互（默认 > 30 轮）后才会启动，并在此后周期性地运行。
- **执行过程**:
    1.  **提取历史**: 服务会提取最近 20 轮的对话历史。
    2.  **调用“诊断专家”**: 它会使用一个特殊的、长篇的系统提示（`LOOP_DETECTION_SYSTEM_PROMPT`），指示一个快速模型（如 `gemini-1.5-flash`）扮演“AI 诊断专家”的角色。
    3.  **请求分析**: 它要求这个“诊断专家”分析提供的对话历史，并以 JSON 格式返回其对“当前对话是否陷入了无效循环”的**推理过程**和**置信度（0.0-1.0）**。
- **触发条件**: 如果“诊断专家”返回的置信度**高于 0.9**，则判定为认知循环。
- **动态间隔**: 该检查的执行频率会根据上次返回的置信度动态调整。置信度越低，下次检查的间隔就越长。

## 4. 中断与用户控制

一旦上述任何一种机制检测到循环，`GeminiClient` 就会立即中断与 API 的通信，并向上层 UI 抛出一个 `LoopDetected` 事件。

UI 层在收到该事件后，并不会直接终止程序，而是会弹出一个确认对话框，将最终的控制权交给用户。用户可以选择：

- **取消操作**: 放弃当前的任务。
- **在本会话中禁用循环检测**: 临时关闭安全功能，并让 Agent 重试刚才的操作。这为处理某些必须重复操作的特殊合法场景提供了灵活性。

通过这种“检测-中断-用户确认”的闭环处理，`LoopDetectionService` 在保证 Agent 安全性和稳定性的同时，也兼顾了灵活性和用户体验。